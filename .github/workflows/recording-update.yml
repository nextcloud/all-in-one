name: recording-update

on:
  workflow_dispatch:
  schedule:
  - cron:  '00 12 * * *'

jobs:
  run_update:
    name: update spreed
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Run spreed-update
      run: |
        # Spreed
        spreed_version="$(
          git ls-remote https://github.com/nextcloud/spreed v*.*.* \
            | cut -d/ -f3 \
            | sort -V \
            | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" \
            | tail -1
        )"
        sed -i "s|git clone --recursive https://github.com/nextcloud/spreed --branch .* /src; \\\|git clone --recursive https://github.com/nextcloud/spreed --branch $spreed_version /src; \\\|" ./Containers/talk-recording/Dockerfile
        curl -L "https://raw.githubusercontent.com/nextcloud/spreed/$spreed_version/talk-recording/server.conf.in" -o Containers/recording/recording.conf
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        commit-message: recording-update automated change
        signoff: true
        title: recording update
        body: Automated recording container update
        labels: dependencies, 3. to review
        milestone: next
        branch: recording-container-update
